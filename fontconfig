#!/bin/bash

set -e  # Exit on error
temp_dir=$(mktemp -d)
font_dir=~/.local/share/fonts

# AUR Setup
if ! grep -q "\[chaotic-aur\]" /etc/pacman.conf; then
    echo "󰖷 Setting up Chaotic AUR..."
    {
        sudo pacman-key --recv-key 3056513887B78AEB --keyserver keyserver.ubuntu.com
        sudo pacman-key --lsign-key 3056513887B78AEB
        sudo pacman -U --noconfirm --needed \
            'https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-keyring.pkg.tar.zst' \
            'https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-mirrorlist.pkg.tar.zst'
        echo -e "\n[chaotic-aur]\nInclude = /etc/pacman.d/chaotic-mirrorlist" | sudo tee -a /etc/pacman.conf > /dev/null
        sudo pacman -Sy
    } &> /dev/null
echo " Chaotic AUR added successfully."
else
    echo "󰋑 Chaotic AUR is already configured."
fi
if ! command -v paru &> /dev/null; then
    echo "󰏗 Installing paru..."
    sudo pacman -S --noconfirm paru &> /dev/null
    echo -e " Successfully installed $package.\n"
else
    echo "󰋑 paru is already installed."
fi


# Sorted list of font packages in alphabetical order
fonts=(
    inter-font
    ttf-meslo-nerd
    ttf-apple-emoji
    otf-noto-sans-cjk
)

# Install each font package if not already installed
for font in "${fonts[@]}"; do
    if pacman -Q "$font" &>/dev/null; then
        echo " $font is already installed."
    else
        echo " Installing $font..."
        if paru -S --noconfirm --quiet "$font" &>/dev/null; then
            echo " Successfully installed $font."
        else
            echo " Failed to install $font." >&2
        fi
    fi
done

# Ensure the fonts directory exists
font_dir="$HOME/.local/share/fonts"
mkdir -p "$font_dir"

# Ensure fontconfig directory exists
fontconfig_dir="$HOME/.config/fontconfig"
mkdir -p "$fontconfig_dir"

# Remove the current fonts.conf if it exists
if [ -f "$fontconfig_dir/fonts.conf" ]; then
    echo "󰖷 Removing existing fonts.conf file..."
    rm "$fontconfig_dir/fonts.conf"
fi

# Apply the new font configuration
echo "󰖷 Configuring font settings..."
cat <<EOL > "$fontconfig_dir/fonts.conf"
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE fontconfig PUBLIC "-//Freetype//DTD FONTCONFIG 2.12//EN" "http://www.freedesktop.org/standards/fontconfig/fontconfig.dtd">
<fontconfig>
    <match>
        <test name="family" qual="any">
            <string>Inter</string>
        </test>
        <edit name="family" mode="prepend" binding="same">
            <string>Inter</string>
        </edit>
    </match>

    <match>
        <test name="family" qual="any">
            <string>monospace</string>
        </test>
        <edit name="family" mode="prepend" binding="same">
            <string>MesloLGS Nerd Font Mono</string>
        </edit>
    </match>

    <match>
        <test name="family" qual="any">
            <string>emoji</string>
        </test>
        <edit name="family" mode="prepend" binding="same">
            <string>Apple Color Emoji</string>
        </edit>
    </match>

    <match>
        <test name="family" qual="any">
            <string>sans-serif</string>
        </test>
        <edit name="family" mode="prepend" binding="same">
            <string>Noto Sans CJK</string>
        </edit>
    </match>

    <match>
        <test name="family" qual="any">
            <string>serif</string>
        </test>
        <edit name="family" mode="prepend" binding="same">
            <string>Noto Serif CJK</string>
        </edit>
    </match>
</fontconfig>
EOL
fc-cache -r

# Apply Inter font for GNOME if running GNOME
if [ "$XDG_CURRENT_DESKTOP" = "GNOME" ]; then
    echo "󰖷 Applying Inter font to GTK..."
    gsettings set org.gnome.desktop.interface font-name 'Inter 13' &>/dev/null
fi

echo -e " Font configuration applied successfully."
